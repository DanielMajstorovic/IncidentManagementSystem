<div class="analytics-container">
  <!-- Error Message -->
  <div class="message error-message" *ngIf="error">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="15" y1="9" x2="9" y2="15"/>
      <line x1="9" y1="9" x2="15" y2="15"/>
    </svg>
    {{ error }}
    <button class="close-btn" (click)="error = ''">Ã—</button>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="loading-card">
      <div class="spinner"></div>
      <span>Loading Analytics Data...</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="analytics-content" *ngIf="!loading && !error">
    <!-- Summary Stats -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon total">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2z"/>
            <path d="M19 7h-4a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getTotalIncidents() }}</div>
          <div class="stat-label">Total Incidents</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon city">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getMostActiveCity() }}</div>
          <div class="stat-label">Most Active City</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon type">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 2 7 12 12 22 7 12 2"/>
            <polyline points="2 17 12 22 22 17"/>
            <polyline points="2 12 12 17 22 12"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getMostCommonType() }}</div>
          <div class="stat-label">Top Incident Type</div>
        </div>
      </div>
    </div>

    <!-- Main Dashboard Layout -->
    <div class="dashboard-layout">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Calendar Card -->
        <div class="dashboard-card calendar-card">
          <div class="card-header">
            <h3 class="card-title">
              <svg class="title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              Incidents by Day
            </h3>
            <div class="calendar-nav">
              <button class="nav-btn" (click)="changeMonth(-1)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15,18 9,12 15,6"/>
                </svg>
              </button>
              <span class="month-display">{{ currentDate | date:'MMMM yyyy' }}</span>
              <button class="nav-btn" (click)="changeMonth(1)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9,18 15,12 9,6"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="calendar-grid">
              <div *ngFor="let weekday of weekdays" class="weekday">{{ weekday }}</div>
              <div *ngFor="let day of calendarDays" class="day" [class.today]="day.isToday">
                <span *ngIf="day.dayOfMonth" class="day-number">{{ day.dayOfMonth }}</span>
                <span *ngIf="day.incidentCount > 0" class="incident-count">{{ day.incidentCount }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Incidents by Type Card -->
        <div class="dashboard-card type-card">
          <div class="card-header">
            <h3 class="card-title">
              <svg class="title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Incidents by Type
            </h3>
          </div>
          <div class="card-body">
            <div class="bar-chart compact" *ngIf="incidentsByType.length > 0; else noTypeData">
              <div *ngFor="let item of incidentsByType" class="bar-row">
                <span class="bar-label">{{ item.key }}</span>
                <div class="bar-container">
                  <div class="bar bar-type" [style.width.%]="getBarWidth(item.count, incidentsByType)"></div>
                </div>
                <span class="bar-count">{{ item.count }}</span>
              </div>
            </div>
            <ng-template #noTypeData>
              <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="m9 9 3 3-3 3"/>
                </svg>
                <p>No incident type data available</p>
              </div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">
        <!-- Incidents by City Card -->
        <div class="dashboard-card city-card">
          <div class="card-header">
            <h3 class="card-title">
              <svg class="title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
              Incidents by City
            </h3>
            <div class="card-subtitle">{{ incidentsByCity.length }} cities with incidents</div>
          </div>
          <div class="card-body">
            <div class="bar-chart scrollable" *ngIf="incidentsByCity.length > 0; else noCityData">
              <div *ngFor="let item of incidentsByCity; trackBy: trackByKey" class="bar-row">
                <span class="bar-label" [title]="item.key || 'Unknown'">{{ item.key || 'Unknown' }}</span>
                <div class="bar-container">
                  <div class="bar bar-city" [style.width.%]="getBarWidth(item.count, incidentsByCity)"></div>
                </div>
                <span class="bar-count">{{ item.count }}</span>
              </div>
            </div>
            <ng-template #noCityData>
              <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                  <circle cx="12" cy="10" r="3"/>
                </svg>
                <p>No city data available</p>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>